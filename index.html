<!DOCTYPE HTML>
<html>
    <head>
        <title>JSONEditor</title>

        <!-- when using the mode "code", it's important to specify charset utf-8 -->
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8">

        <link href="bower_components/jsoneditor/dist/jsoneditor.css" rel="stylesheet" type="text/css">
        <script src="bower_components/jsoneditor/dist/jsoneditor.js"></script>

        <style type="text/css">
            body {
                font: 12pt monaco;
                color: #4d4d4d;
                line-height: 150%;
                margin:0;
                padding:0;
            }
            code {
                background-color: #f5f5f5;
            }
            div.jsoneditor{
                border:none;
            }
            #jsoneditor {
                font-size: 18px;
                width: 100%;
                height: 500px;
            }
        </style>
    </head>
    <body>

        <div id="jsoneditor"></div>

        <script>

            // Importanted API
            var gui = require('nw.gui');
            var clipboard = gui.Clipboard.get();
            var gui_window = gui.Window.get();


            //Same as $(document).ready();
            function ready(fn) {
                if (document.readyState != 'loading'){
                  fn();
                } else {
                  document.addEventListener('DOMContentLoaded', fn);
                }
            }

            // Copy Short-cut options
            var copy = {
                key : "Ctrl+C",
                active : function() {
                    cp.set(editor.getText(),"text");
                },
                failed : function(msg) {
                    // :(, fail to register the |key| or couldn't parse the |key|.
                    console.log(msg);
                }
            };

            // Paste Short-cut options
            var paste = {
                key : "Ctrl+V",
                active : function() {
                    var data = cp.get("text");
                    editor.aceEditor.insert(data);
                },
                failed : function(msg) {
                    // :(, fail to register the |key| or couldn't parse the |key|.
                    console.log(msg);
                }
            };

            // Quit short-cut options
            var quit = {
                key : "Ctrl+Q",
                active : function() {
                    gui.App.quit();
                },
                failed : function(msg) {
                    // :(, fail to register the |key| or couldn't parse the |key|.
                    console.log(msg);
                }
            };

            // Quit short-cut options
            var close_window = {
                key : "Ctrl+W",
                active : function() {
                    //TODO: Save file if needed.
                    gui_window.close(true);
                },
                failed : function(msg) {
                    // :(, fail to register the |key| or couldn't parse the |key|.
                    console.log(msg);
                }
            };

            // Quit short-cut options
            var new_window = {
                key : "Ctrl+N",
                active : function() {
                    //TODO: Save file if needed.
                    gui.Window.open("index.html",{focus: true});
                },
                failed : function(msg) {
                    // :(, fail to register the |key| or couldn't parse the |key|.
                    console.log(msg);
                }
            };
            // Create a shortcut with |option|.
            var quit_shortcut = new gui.Shortcut(quit);
            var copy_shortcut = new gui.Shortcut(copy);
            var paste_shortcut = new gui.Shortcut(paste);
            var close_window_shortcut = new gui.Shortcut(close_window);
            var new_window_shortcut = new gui.Shortcut(new_window);

            // Editor Contiainer and Options
            var container = document.getElementById('jsoneditor');
            var options = {
                mode: 'code',
                modes: ['code', 'tree', 'text'], // allowed modes
                onError: function (err) {
                    alert(err.toString());
                },
                onModeChange: function (newMode, oldMode) {
                    console.log('Mode switched from', oldMode, 'to', newMode);
                }
            };
            var editor = new JSONEditor(container, options, null);


            // Set editor height
            document.getElementById("jsoneditor").style.height = (window.innerHeight - 5 )+ "px";

            // Auto resize function
            window.onresize = function(){
                document.getElementById("jsoneditor").style.height = (window.innerHeight - 5 )+ "px";
            }

            //default shortcut bind
            gui.App.registerGlobalHotKey(quit_shortcut);
            gui.App.registerGlobalHotKey(copy_shortcut);
            gui.App.registerGlobalHotKey(paste_shortcut);
            gui.App.registerGlobalHotKey(close_window_shortcut);
            gui.App.registerGlobalHotKey(new_window_shortcut);

            gui_window.on('focus', function(){
                gui.App.registerGlobalHotKey(quit_shortcut);
                gui.App.registerGlobalHotKey(copy_shortcut);
                gui.App.registerGlobalHotKey(paste_shortcut);
                gui.App.registerGlobalHotKey(close_window_shortcut);
                gui.App.registerGlobalHotKey(new_window_shortcut);
            });

            gui_window.on('blur', function(){
                gui.App.unregisterGlobalHotKey(quit_shortcut);
                gui.App.unregisterGlobalHotKey(copy_shortcut);
                gui.App.unregisterGlobalHotKey(paste_shortcut);
                gui.App.unregisterGlobalHotKey(close_window_shortcut);
                gui.App.unregisterGlobalHotKey(new_window_shortcut);
            });
        </script>
    </body>
</html>

